<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mock WhatsApp Simulator</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #111; color: #eee; }
      .container { max-width: 680px; margin: 0 auto; padding: 16px; }
      header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
      h1 { font-size: 20px; margin: 0; }
      form { display: grid; gap: 10px; grid-template-columns: 1fr; }
      input, textarea, button { font-size: 16px; padding: 10px; border-radius: 6px; border: 1px solid #333; background: #0f0f0f; color: #eee; }
      textarea { min-height: 100px; }
      button { background: #22c55e; border-color: #16a34a; cursor: pointer; }
      button:hover { background: #16a34a; }
      .result { margin-top: 12px; font-size: 14px; color: #9aa0a6; white-space: pre-wrap; }
      .hint { color: #9aa0a6; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Mock WhatsApp Simulator</h1>
      </header>

      <div class="hint">Use this to simulate a WhatsApp user sending a message into your inbox. The conversation will be assigned to an available agent if possible.</div>

      <form id="form">
        <input id="extId" type="text" placeholder="Customer External ID (e.g., phone number)" required />
        <input id="name" type="text" placeholder="Customer Name (optional)" />
        <textarea id="content" placeholder="Message text" required></textarea>
        <button type="submit">Send inbound message</button>
      </form>

      <div class="result" id="result"></div>

      <h3>Live thread</h3>
      <ul id="messages" style="list-style:none; padding:0; border:1px solid #333; border-radius:8px; background:#181818; height:45vh; overflow:auto;"></ul>

      <p class="hint">Tip: Open the Agent Console (/agent). After sending, the conversation should appear and the message will show in the thread when you open it.</p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const form = document.getElementById('form');
      const result = document.getElementById('result');
      const messages = document.getElementById('messages');
      const socket = io();
      let conversationId = null;

      function escapeHtml(str){
        return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
      }

      function appendMessage(m){
        if (!conversationId || m.conversation_id !== conversationId) return;
        const li = document.createElement('li');
        const who = m.sender === 'agent' ? 'Agent' : 'Customer';
        const ts = m.created_at ? new Date(m.created_at) : new Date();
        li.innerHTML = `<span style="color:#9aa0a6; font-size:12px; margin-right:6px;">[${ts.toLocaleTimeString()}] ${who}:</span> ${escapeHtml(m.content || '')}`;
        messages.appendChild(li);
        messages.scrollTop = messages.scrollHeight;
      }

      async function ensureAttached(){
        const extId = document.getElementById('extId').value.trim();
        if (!extId) return;
        const res = await fetch(`/mock/whatsapp/get?customerExternalId=${encodeURIComponent(extId)}`);
        if (res.ok){
          const conv = await res.json();
          conversationId = conv.id;
          socket.emit('conversation:join', { conversationId });
          const history = await fetch(`/messages?conversationId=${conversationId}`).then(r=>r.json());
          messages.innerHTML = '';
          history.forEach(appendMessage);
        }
      }

      socket.on('conversation:joined', () => {});
      socket.on('conversation:message', appendMessage);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          customerExternalId: document.getElementById('extId').value.trim(),
          customerName: document.getElementById('name').value.trim(),
          content: document.getElementById('content').value.trim()
        };
        try {
          const res = await fetch('/mock/whatsapp/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const data = await res.json();
          result.textContent = JSON.stringify(data, null, 2);
          if (data.conversation?.id){
            conversationId = data.conversation.id;
            socket.emit('conversation:join', { conversationId });
            appendMessage(data.message);
          }
        } catch (err) {
          result.textContent = 'Error: ' + err.message;
        }
      });

      // Auto attach when extId changes
      document.getElementById('extId').addEventListener('change', ensureAttached);
    </script>
  </body>
</html>


<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Realtime Chat</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="header">
    <div class="row">
      <div class="title">Realtime Chat</div>
      <span class="badge">Legacy global chat</span>
    </div>
    <div class="row">
      <a class="button ghost" href="/customer">Customer</a>
      <a class="button ghost" href="/agent">Agent</a>
      <a class="button ghost" href="/privacy">Privacy</a>
      <a class="button ghost" href="/terms">Terms</a>
    </div>
  </div>

  <div class="main">
    <div class="chat">
      <div id="messages" class="messages"></div>
    </div>
    <form id="composer" class="composer" autocomplete="off">
      <input id="name" class="input" type="text" placeholder="Your name" value="Anonymous" style="max-width:220px" />
      <input id="input" class="input" type="text" placeholder="Type a message..." />
      <button class="button" type="submit">Send</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const composer = document.getElementById('composer');
    const input = document.getElementById('input');
    const nameInput = document.getElementById('name');
    const messages = document.getElementById('messages');

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    function bubble(m){
      const div = document.createElement('div');
      const ts = m.created_at ? new Date(m.created_at) : new Date();
      div.className = 'msg customer';
      div.innerHTML = `<span class="meta">${escapeHtml(m.username || 'Anonymous')} â€¢ ${ts.toLocaleTimeString()}</span>${escapeHtml(m.content || '')}`;
      return div;
    }

    function appendMessage(m){
      messages.appendChild(bubble(m));
      messages.scrollTop = messages.scrollHeight;
    }

    fetch('/messages')
      .then(r => r.json())
      .then(list => list.forEach(appendMessage))
      .catch(console.error);

    socket.on('chat:message', appendMessage);

    composer.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = input.value.trim();
      const username = nameInput.value.trim() || 'Anonymous';
      if (!text) return;
      socket.emit('chat:message', { username, content: text });
      input.value = '';
      input.focus();
    });
  </script>
</body>
</html>
